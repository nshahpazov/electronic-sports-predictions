---
title: "prior-classification"
author: "Nikola Shahpazov"
date: "1/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r package-setup, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
list.of.packages <- c(
  "Metrics",
  "reshape",
  "glue",
  "tidyverse",
  "caret",
  "recipes",
  "purrr",
  "jsonlite"
)

new.packages <- list.of.packages[(
  !list.of.packages %in% installed.packages() |
   list.of.packages %in% old.packages()[ ,"Package"]
)]

if (length(new.packages)) {
  install.packages(new.packages, repos = "http://cran.us.r-project.org")
}

## Load all necessary packages in RAM (working environment)
lapply(list.of.packages, require, character.only = TRUE)

rm(list.of.packages, new.packages)
```

### Loading the data

```{r loading-data}
players_df <- read.csv("./data/players.csv")
player_ratings_df <- read.csv("./data/player_ratings.csv")
matches_df <- read.csv("./data/match.csv",
                       colClasses = c(radiant_win = "logical"))

hero_stats_df <- "./data/hero_stats.json" %>%
  jsonlite::fromJSON(flatten = TRUE) %>%
  select(
    hero_id, attack_range, projectile_speed,
    attack_rate, move_speed, turn_rate,
    starts_with("base"), ends_with("gain")
  )
```
## Feature Engineering

### Hero selection feature engineering

Heroes dataframe containing a a 224 dimensional vector where
x_n = 1 if the nth hero is in the radiant team and x_(n+113) if the nth hero is
in the dire team for the match

```{r feature-engineering-hero-selection}
heroes_df <- players_df %>%
  mutate(hero_id = ifelse(player_slot > 5, hero_id + 113, hero_id)) %>%
  mutate(val = 1) %>%
  pivot_wider(
    names_from = "hero_id",
    values_from = "val",
    values_fill = 0,
    names_glue = "hero_{hero_id}"
  ) %>%
  select(match_id, starts_with("hero")) %>%
  select(-hero_damage, -hero_healing) %>%
  group_by(match_id) %>%
  summarise(across(everything(), ~sum(.x, na.rm = TRUE)))
```
### Hero Statistics feature engineering

A dataframe containing the hero statistics of each of the ten players
for each game
```{r feature-engineering-hero-stats}
matches_hero_stats_df <- players_df %>%
  select(match_id, hero_id, player_slot) %>%
  left_join(hero_stats_df, by = "hero_id") %>%
  select(-hero_id) %>%
  pivot_wider(
    names_from = "player_slot",
    values_from = colnames(hero_stats_df)[-1]
  ) %>%
  mutate(across(everything(), ~replace_na(.x, 0)))
```

### Winning rate of hero against other hero
```{r feature-engineering-heroes-winning-ratios}
team_heroes_df <- players_df %>%
  left_join(select(matches_df, match_id, radiant_win), by = "match_id") %>%
  mutate(team = ifelse(player_slot < 6, "hero_team_1", "hero_team_2")) %>%
  select(match_id, team, hero_id, radiant_win) %>%
  pivot_wider(names_from = team, values_from = hero_id) %>%
  unchop(everything())


generate_frequencies <- function (hero_matches_df) {
  crossing(hero_team_1 = 0:112, hero_team_2 = 0:112)  %>%
    filter(hero_team_1 != hero_team_2) %>%
    left_join(., count(hero_matches_df, hero_team_1, hero_team_2)) %>%
    mutate(n = replace_na(n, 1))
}

winners_hero_freq_df <- team_heroes_df %>%
  filter(radiant_win) %>%
  generate_frequencies()

losers_hero_freq_df <- team_heroes_df %>%
  filter(!radiant_win) %>%
  generate_frequencies()

hero_win_lose_ratios_df <- winners_hero_freq_df %>%
  mutate(ratio = n / losers_hero_freq_df$n) %>%
  select(-n)
```


### Some simple modeling with regularization

```{r training-models}
train_indices <- createDataPartition(heroes_df$match_id, p = .8, list = FALSE)
data <- matches_df %>%
  select(match_id, radiant_win) %>%
  left_join(heroes_df, by = "match_id") %>%
  left_join(matches_hero_stats_df, by = "match_id") %>%
  mutate(radiant_win = as.factor(ifelse(radiant_win, "yes", "no")))

heroes_train_df <- data[train_indices, ]
heroes_test_df <- data[-train_indices, ]

train_control <- trainControl(
  method = "cv",
  number = 5,
  summaryFunction = twoClassSummary,
  classProbs = TRUE
)

hero_glm_model <- train(
  form = radiant_win ~ .,
  data = heroes_train_df,
  trControl = train_control,
  method = "glmnet",
  metric = "Accuracy",
  family = "binomial"
)

hero_glm_model$results
```