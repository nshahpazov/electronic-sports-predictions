---
title: "prior-classification"
author: "Nikola Shahpazov"
date: "1/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r package-setup, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
list.of.packages <- c(
  "Metrics",
  "reshape",
  "glue",
  "tidyverse",
  "caret",
  "recipes",
  "purrr",
  "jsonlite"
)

new.packages <- list.of.packages[(
  !list.of.packages %in% installed.packages() |
   list.of.packages %in% old.packages()[ ,"Package"]
)]

if (length(new.packages)) {
  install.packages(new.packages, repos = "http://cran.us.r-project.org")
}

## Load all necessary packages in RAM (working environment)
lapply(list.of.packages, require, character.only = TRUE)

rm(list.of.packages, new.packages)
```

```{r load-helper-files}
source("./prior-helpers.R")
```

### Loading the data

```{r loading-data}
players_df <- read.csv("./data/players.csv")
player_ratings_df <- read.csv("./data/player_ratings.csv")
matches_df <- read.csv("./data/match.csv",
                       colClasses = c(radiant_win = "logical"))

hero_stats_df <- "./data/hero_stats.json" %>%
  jsonlite::fromJSON(flatten = TRUE) %>%
  select(
    hero_id, attack_range, projectile_speed,
    attack_rate, move_speed, turn_rate,
    starts_with("base"), ends_with("gain")
  )
```
## Clean Data
```{r}
# drop match 2134 since it has two heroes with 0 id
matches_df <- filter(matches_df, match_id != 2134)
players_df <- filter(players_df, match_id != 2134)
```

## Feature Engineering

### Hero selection feature engineering

Heroes dataframe containing a a 224 dimensional vector where
x_n = 1 if the nth hero is in the radiant team and x_(n+113) if the nth hero is
in the dire team for the match

```{r feature-engineering-hero-selection}
heroes_df <- players_df %>%
  mutate(hero_id = ifelse(player_slot > 5, hero_id + 113, hero_id)) %>%
  mutate(val = 1) %>%
  pivot_wider(
    names_from = "hero_id",
    values_from = "val",
    values_fill = 0,
    names_glue = "hero_{hero_id}"
  ) %>%
  select(match_id, starts_with("hero")) %>%
  select(-hero_damage, -hero_healing) %>%
  group_by(match_id) %>%
  summarise(across(everything(), ~sum(.x, na.rm = TRUE)))
```
### Hero Statistics feature engineering

A create a dataframe containing the hero statistics of each of the ten players
for each game like mana generation, base health, strength, durability, etc.

```{r feature-engineering-hero-stats}
matches_hero_stats_df <- players_df %>%
  select(match_id, hero_id, player_slot) %>%
  left_join(hero_stats_df, by = "hero_id") %>%
  select(-hero_id) %>%
  pivot_wider(
    names_from = "player_slot",
    values_from = colnames(hero_stats_df)[-1]
  ) %>%
  mutate(across(everything(), ~replace_na(.x, 0)))
```

### Winning rate of hero against other hero feature engineering

We create a data frame with all the combinations of different heroes and their
corresponding ratio of winning over losing calculated from all the games

```{r feature-engineering-heroes-winning-ratios}
# TODO: this should be done only on a training set to prevent data leakage
# TODO: do a join on the whole data frame
# TODO: join with player ranks as well
team_heroes_df <- generate_team_heroes_df(players_df)
team_heroes_ratios_df <- generate_ratios_df(team_heroes_df)

hero_combos <- team_heroes_df %>%
  group_by(match_id) %>%
  expand(hero_team_1, hero_team_2) %>%
  ungroup()

hero_combos_ratios_df <- hero_combos %>%
  arrange(match_id) %>%
  mutate(n = c(rep(seq(1, 25), 50000 - 1))) %>%
  merge(team_heroes_ratios_df, by = c("hero_team_1", "hero_team_2")) %>%
  pivot_wider(
    id_cols = match_id,
    names_from = n,
    values_from = ratio,
    names_glue = "hero_combo_{n}"
  )

```
### Player rankings feature engineering

```{r feature-engineering-player-rankings}
matches_player_rankings_df <- players_df %>%
  select(match_id, account_id) %>%
  left_join(player_ratings_df, by = "account_id") %>%
  arrange(match_id) %>%
  mutate(n = rep(seq(1, 10), 49999)) %>%
  pivot_wider(
    names_from = n,
    id_cols = match_id,
    values_from = c(trueskill_mu, trueskill_sigma, total_matches, total_wins)
  )
```


### Some simple modeling with regularization

We explore different classification mechanisms on the around 500-dimensional
data frame of different matches constructed by us from the previous feature 
engineering steps above. 

```{r training-models}

train_indices <- createDataPartition(heroes_df$match_id, p = .8, list = FALSE)
match_data <- matches_df %>%
  select(match_id, radiant_win) %>%
  # join with the selected heroes vectors
  left_join(heroes_df, by = "match_id") %>%
  # join with the hero statistics
  left_join(matches_hero_stats_df, by = "match_id") %>%
  # join with team_heroes ratios

  mutate(radiant_win = as.factor(ifelse(radiant_win, "yes", "no")))

heroes_train_df <- match_data[train_indices, ]
heroes_test_df <- match_data[-train_indices, ]

train_control <- trainControl(
  method = "cv",
  number = 5,
  summaryFunction = twoClassSummary,
  classProbs = TRUE
)

hero_glm_model <- train(
  form = radiant_win ~ .,
  data = heroes_train_df,
  trControl = train_control,
  method = "glmnet",
  metric = "Accuracy",
  family = "binomial"
)

hero_glm_model$results
```