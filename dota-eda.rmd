---
title: "Dota"
author: "Nikola Shahpazov"
date: "12/3/2020"
output: html_document
---



```{r constants}
WINDOW_COLS <- c("gold_difference", "xp_difference", "lh_difference")
```

```{r load-inner-modules}
source("helpers.R")
source("markov-chains-helpers.R")
```

### Loading data
```{r load-data}
matches_df <- read.csv("./data/match.csv",
                       colClasses = c(radiant_win = "logical"))
time_df <- read.csv('./data/player_time.csv')
```

### Preprocessing

```{r prepare-data}
diffs_by_time_df <- time_df %>%
  mutate(gold_difference = diff_means(., "gold_t_[0-4]$", "gold_t_1[2-3]")) %>%
  mutate(xp_difference = diff_means(., "xp_t_[0-4]$", "xp_t_1[2-3]")) %>%
  mutate(lh_difference = diff_means(., "lh_t_[0-4]$", "lh_t_1[2-3]")) %>%
  mutate(minute = times / 60) %>%
  select(match_id, minute, gold_difference, xp_difference, lh_difference) %>%
  pivot_wider(id_cols = "match_id", names_from = "minute",
              values_from = WINDOW_COLS) %>%
  select(-gold_difference_0, -xp_difference_0, -lh_difference_0) %>%
  left_join(select(matches_df, match_id, radiant_win, duration),
            by = "match_id") %>%
  mutate(radiant_win = as.factor(radiant_win))

```

### Train set and Test set split

```{r test-train-split}
train_indices <- createDataPartition(diffs_by_time_df$radiant_win,
                                     p = .8,
                                     list = FALSE,
                                     times = 1)

train_set <- diffs_by_time_df[train_indices, ]
test_set <- diffs_by_time_df[-train_indices, ]
```

### Train various logistic regression models

```{r train-time-windows-lr}
tc <- trainControl(method = "cv", number = 5)

train_set_std <- standardize_time_df(train_set)
test_set_std <- standardize_time_df(test_set)

# slr_all <- train_lr(data = train_set_std, cols = WINDOW_COLS, control = tc)
slr_gld <- train_lr(data = train_set_std, cols = WINDOW_COLS[1], control = tc)
slr_glh <- train_lr(data = train_set_std, cols = WINDOW_COLS[-2], control = tc)

lr_models <- list(
  # "slr_all" = slr_all,
  "slr_gld" = slr_gld,
  "slr_glh" = slr_glh
)
```

### Explore Cross Validation Test Accuracy

```{r plot-cv-acuracy}
lr_models %>%
  map(~imap(., ~.$results$Accuracy)) %>%
  imap(~data.frame(accuracy = unlist(.), time = 6:101, model = .y)) %>%
  bind_rows() %>%
  ggplot(mapping = aes(x = time, y = accuracy, color = model)) +
  geom_line() +
  ggtitle("Training set CV Accuracy")
```

We see that SLR with gold and last hits (gold is correlated with xp) behaves the best till the 
80th minute and after that it starts oscillating a lot, probably because 
there aren't a lot of matches then, or the matches are very even.

```{r prediction-accuracies}
test_performance <- lr_models %>%
  imap(
    ~data.frame(
      accuracy = get_test_accuracies(., test_set_std),
      time = 5:95,
      model = .y
    )
  ) %>%
  bind_rows()

test_performance %>%
  ggplot(mapping = aes(x = time, y = accuracy, color = model)) +
  geom_line() +
  ggtitle("Test Set Accuracy")
```
We see that the test accuracy behaves similarly to the test set cv accuracy from above.

### Markov Chains Model (WIP)

```{r markov-chain-model, message=FALSE, warning=FALSE, include=FALSE}
# create winners transition matrix
winners_tm <- train_set %>%
  filter(as.logical(radiant_win)) %>%
  as_binned_matrix(nbin = 20) %>%
  construct_transition_matrix(nbin = 20)

# create losers transition matrix
losers_tm <-  train_set %>%
  filter(!as.logical(radiant_win)) %>%
  as_binned_matrix(nbin = 20) %>%
  construct_transition_matrix(nbin = 20)

# plot winners transition matrix
winners_tm %>%
  matrix_to_df() %>%
  ggplot(mapping = aes(row, col, fill = value)) + 
    geom_tile() +
    geom_text(aes(label = round(value, 1))) +
    ggtitle("Transition changes for the Winning team in the train set") +
    xlab("Gold Bin States") +
    ylab("Gold Bin States")

# plot losers transition matrix
losers_tm %>%
  matrix_to_df() %>%
  ggplot(mapping = aes(row, col, fill = value)) + 
    geom_tile() +
    geom_text(aes(label = round(value, 1))) +
    ggtitle("Transition changes for the Losing team in the train set") +
    xlab("Gold Bin States") +
    ylab("Gold Bin States")
```

```{r markov-chains-model-predictions, include=FALSE}

get_traj_prob <- function (bm, tm, t = 1, window = 5) {
  probs <- c()
  for (i in 1:nrow(bm)) {
    prob <- 1
    for (j in t:t + window - 1) {
      current <- tm[ bm[i, j] ,bm[i , j + 1] ]
      prob <- prob * ifelse(is.na(current), 1, current)
    }
    probs[i] <- prob
  }
  probs
}

tsbm <- as_binned_matrix(test_set, nbin = 20)

d_win <- get_traj_prob(tsbm, winners_tm, t = 34)
d_los <- get_traj_prob(tsbm, losers_tm, t = 34)

is_win <- (d_win / (d_win + d_los)) > 0.5

mean(0 + (is_win == test_set$radiant_win), na.rm = TRUE)
# weak result

tsbm %>% rownames()

```